<!doctype html public "-//W3C//DTD HTML 4.0 Frameset//EN""http://www.w3.org/TR/REC-html40/frameset.dtd">
<html>
<head>
<title>
Jala 1.0 Overview
</title>
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script>
function asd() {
	
		parent.document.title="BitTorrent.js Overview";
	
}
</script>
</head>
<body bgcolor="white" onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> 	<font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top">
<em>
<b>Jala 1.0</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<center>
	
	   <h2>BitTorrent.js</h2>
	
</center>

	


<h4>Summary</h4>
<p>
	
		Fields and methods of the jala.BitTorrent class.<BR/><BR/>
	
</p>

<hr>


    <table border="1" cellpadding="3" cellspacing="0" width="100%">
    <tr bgcolor="#CCCCFF" class="TableHeadingColor">
    <td colspan=2><font size="+2">
    
        <b>Class Summary</b>
    
    </font></td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="jala.BitTorrent.html">jala.BitTorrent</a></b></td>
    <td>This class provides methods to create a BitTorrent
 metadata file from any desired file.</td>
    </tr>
    
    </table>
    <hr/> 


<!-- ========== METHOD SUMMARY =========== -->

<!-- ========== END METHOD SUMMARY =========== -->


        <pre class="sourceview"><span class="comment">//</span>
<span class="comment">// Jala Project [http://opensvn.csie.org/traccgi/jala]</span>
<span class="comment">//</span>
<span class="comment">// Copyright 2004 ORF Online und Teletext GmbH</span>
<span class="comment">//</span>
<span class="comment">// Licensed under the Apache License, Version 2.0 (the ``License'');</span>
<span class="comment">// you may not use this file except in compliance with the License.</span>
<span class="comment">// You may obtain a copy of the License at</span>
<span class="comment">//</span>
<span class="comment">//    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="comment">//</span>
<span class="comment">// Unless required by applicable law or agreed to in writing, software</span>
<span class="comment">// distributed under the License is distributed on an ``AS IS'' BASIS,</span>
<span class="comment">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="comment">// See the License for the specific language governing permissions and</span>
<span class="comment">// limitations under the License.</span>
<span class="comment">//</span>
<span class="comment">// $Revision$</span>
<span class="comment">// $LastChangedBy$</span>
<span class="comment">// $LastChangedDate$</span>
<span class="comment">// $HeadURL$</span>
<span class="comment">//</span>


<span class="comment">/**
 * <span class="attrib">@fileoverview</span> Fields and methods of the jala.BitTorrent class.
 */</span>


<span class="comment">// Define the global namespace for Jala modules</span>
<span class="reserved">if</span> (!global.jala) {
   global.jala = {};
}


<span class="comment">/**
 * Module dependencies
 */</span>
app.addRepository(<span class="literal">"modules/core/String.js"</span>);
app.addRepository(<span class="literal">"modules/helma/File.js"</span>);


<span class="comment">/**
 * Constructs a new BitTorrent file.
 * <span class="attrib">@class</span> This class provides methods to create a BitTorrent
 * metadata file from any desired file.
 * <span class="attrib">@param</span> {String} trackerUrl The URL string of the tracker.
 * <span class="attrib">@param</span> {String} filePath The path to the original file.
 * <span class="attrib">@returns</span> A new BitTorrent file.
 * <span class="attrib">@constructor</span>
 */</span>
jala.BitTorrent = <span class="reserved">function</span>(filePath, trackerUrl) {
   var self = <span class="reserved">this</span>;
   self.arguments = arguments;

   <span class="comment">// FIXME: Add support for multitracker mode as specified in</span>
   <span class="comment">// http://www.bittornado.com/docs/multitracker-spec.txt</span>
   
   var torrent, sourceFile, torrentFile;
   var pieceLength = 256;

   <span class="comment">/** <span class="attrib">@ignore</span> */</span>
   <span class="reserved">function</span> updateTorrent() {
      <span class="reserved">if</span> (torrent.info) {
         <span class="reserved">return</span> torrent;
      }

      var file = new java.io.File(filePath);
      <span class="reserved">if</span> (!file.exists()) {
         throw Error(<span class="literal">"File "</span> + file + <span class="literal">" does not exist!"</span>);
      }
   
      var md5 = java.security.MessageDigest.getInstance(<span class="literal">"MD5"</span>);
      var sha1 = java.security.MessageDigest.getInstance(<span class="literal">"SHA-1"</span>);   

      var fis = new java.io.FileInputStream(file);
      var bis = new java.io.BufferedInputStream(fis);
      var cache = new java.io.ByteArrayOutputStream();

      var pieces = [];
      var length = pieceLength * 1024;
      var buffer = java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE, length);

      <span class="reserved">while</span> (bis.read(buffer, 0, buffer.length) &gt; -1) {
         app.debug(<span class="literal">"Updating SHA-1 hash with "</span> + buffer.length + <span class="literal">" bytes"</span>);
         sha1.reset();
         sha1[<span class="literal">"update(byte[])"</span>](buffer);
         cache[<span class="literal">"write(byte[])"</span>](buffer);
         pieces.push(new java.lang.String(sha1.digest()));
      }
      
      bis.close();
      fis.close();
 
      torrent.info = {
         <span class="comment">//md5sum: new java.lang.String(md5.digest(cache.toByteArray())),</span>
         length: cache.size(),
         name: file.getName(),
         <span class="literal">"piece length"</span>: length,
         pieces: pieces.join(<span class="literal">""</span>)
      };
      
      <span class="reserved">return</span> torrent;
   }
   
   <span class="comment">/**
    * Get all available property names.
    * <span class="attrib">@returns</span> The list of property names.
    * <span class="attrib">@type</span> Array
    */</span>
   <span class="reserved">this</span>.keys = <span class="reserved">function</span>() {
      var keys = [];
      <span class="reserved">for</span> (var i in torrent) {
         keys.push(i);
      }
      keys.sort();
      <span class="reserved">return</span> keys;
   };

   <span class="comment">/**
    * Get a torrent property.
    * <span class="attrib">@param</span> {String} name The name of the property.
    * <span class="attrib">@returns</span> The value of the property.
    */</span>
   <span class="reserved">this</span>.get = <span class="reserved">function</span>(name) {
      <span class="reserved">return</span> torrent[name];
   };

   <span class="comment">/**
    * Set a torrent property.
    * <span class="attrib">@param</span> {String} name The name of the property.
    * <span class="attrib">@param</span> {Object} value The property's value.
    */</span>
   <span class="reserved">this</span>.set = <span class="reserved">function</span>(name, value) {
      <span class="reserved">if</span> (typeof torrent[name] == <span class="literal">"undefined"</span>) {
         throw Error(<span class="literal">"Cannot set torrent property "</span> + name);
      }
      torrent[name] = value;
      delete torrent.info;
      <span class="reserved">return</span>;
   };

   <span class="comment">/**
    * Get the creation date of the torrent.
    * <span class="attrib">@returns</span> The torrent's creation date.
    * <span class="attrib">@type</span> Date
    */</span>
   <span class="reserved">this</span>.getCreationDate = <span class="reserved">function</span>() {
      <span class="reserved">return</span> new Date(torrent[<span class="literal">"creation date"</span>] * 1000);
   };

   <span class="comment">/**
    * Set the creation date of the torrent.
    * <span class="attrib">@param</span> {Date} date The desired creation date.
    */</span>
   <span class="reserved">this</span>.setCreationDate = <span class="reserved">function</span>(date) {
      <span class="reserved">this</span>.set(<span class="literal">"creation date"</span>, Math.round((date || new Date()).getTime() / 1000));
      <span class="reserved">return</span>;
   };

   <span class="comment">/**
    * Get the piece length of the torrent.
    * <span class="attrib">@returns</span> The torrent's piece length.
    * <span class="attrib">@type</span> Number
    */</span>
   <span class="reserved">this</span>.getPieceLength = <span class="reserved">function</span>() {
      <span class="reserved">return</span> pieceLength;
   };

   <span class="comment">/**
    * Set the piece length of the torrent.
    * <span class="attrib">@param</span> {Number} length The desired piece length.
    */</span>
   <span class="reserved">this</span>.setPieceLength = <span class="reserved">function</span>(length) {
      pieceLength = length;
      delete torrent.info;
      <span class="reserved">return</span>;
   };

   <span class="comment">/**
    * Returns the underlying torrent file.
    * <span class="attrib">@returns</span> The torrent file.
    * <span class="attrib">@type</span> helma.File
    */</span>
   <span class="reserved">this</span>.getTorrentFile = <span class="reserved">function</span>() {
      <span class="reserved">return</span> torrentFile;
   };
   
   <span class="comment">/**
    * Returns the underlying source file.
    * <span class="attrib">@returns</span> The source file.
    * <span class="attrib">@type</span> helma.File
    */</span>
   <span class="reserved">this</span>.getSourceFile = <span class="reserved">function</span>() {
      <span class="reserved">return</span> sourceFile;
   };

   <span class="comment">/**
    * Saves the torrent as file.
    * <span class="attrib">@param</span> {String} filename An optional name for the torrent file.
    * If no name is given it will be composed from name of source
    * file as defined in the torrent plus the ending ".torrent".
    */</span>
   <span class="reserved">this</span>.save = <span class="reserved">function</span>(filename) {
      updateTorrent();
      <span class="reserved">if</span> (!filename) {
         filename = torrent.info.name + <span class="literal">".torrent"</span>;
      }
      torrentFile = new helma.File(sourceFile.getParent(), filename);
      torrentFile.remove();
      torrentFile.open();
      torrentFile.write(jala.BitTorrent.bencode(torrent));
      torrentFile.close();
      <span class="reserved">return</span>;     
   };

   <span class="comment">/**
    * Get a string representation of the torrent.
    * <span class="attrib">@returns</span> The torrent as string.
    * <span class="attrib">@type</span> String
    */</span>
   <span class="reserved">this</span>.toString = <span class="reserved">function</span>() {
      <span class="reserved">return</span> <span class="literal">"[jala.BitTorrent "</span> + filePath + <span class="literal">"]"</span>;
   };

   <span class="reserved">if</span> (String(filePath).endsWith(<span class="literal">".torrent"</span>)) {
      torrentFile = new helma.File(filePath);
      torrent = jala.BitTorrent.bdecode(torrentFile.readAll());
      sourceFile = new helma.File(torrent.info.name);
   } <span class="reserved">else</span> {
      torrent = {
         announce: trackerUrl || null,
         <span class="literal">"announce-list"</span>: null,
         <span class="literal">"creation date"</span>: null,
         comment: null,
         <span class="literal">"created by"</span>: null,
      };
      <span class="reserved">this</span>.setCreationDate();
      sourceFile = new helma.File(filePath);
   }
   
   <span class="reserved">return</span> <span class="reserved">this</span>;
};


<span class="comment">/**
 * The bencode method. Turns an arbitrary JavaScript
 * object structure into a corresponding encoded
 * string.
 * <span class="attrib">@param</span> {Object} obj The target JavaScript object.
 * <span class="attrib">@returns</span> The encoded string.
 * <span class="attrib">@type</span> String
 */</span>
jala.BitTorrent.bencode = <span class="reserved">function</span>(obj) {
   var bencode = arguments.callee;
   var str = obj.toString();
   res.push();
   switch (obj.constructor) {
      case Array:
         res.write(<span class="literal">"l"</span>);
         <span class="reserved">for</span> (var i in obj) {
            <span class="reserved">if</span> (obj[i])
               res.write(bencode(obj[i]));
         }
         res.write(<span class="literal">"e"</span>);
         break;

      case Number:
         res.write(<span class="literal">"i"</span> + str + <span class="literal">"e"</span>);
         break;

      case Object:
         res.write(<span class="literal">"d"</span>);
         var keys = [];
         <span class="reserved">for</span> (var i in obj) {
            keys.push(i);
         }
         keys.sort();
         var key;
         <span class="reserved">for</span> (var i in keys) {
            key = keys[i];
            <span class="reserved">if</span> (obj[key]) {
               res.write(bencode(key));
               res.write(bencode(obj[key]));
            }
         }
         res.write(<span class="literal">"e"</span>);
         break;

      default:
         res.write(str.length + <span class="literal">":"</span> + str);
   }
   <span class="reserved">return</span> res.pop();
};


<span class="comment">/**
 * The bdecode method. Turns an encoded string into
 * a corresponding JavaScript object structure.
 * FIXME: Handle with caution...
 * <span class="attrib">@param</span> {String} code The encoded string.
 * <span class="attrib">@returns</span> The decoded JavaScript structure.
 * <span class="attrib">@type</span> Object
 */</span>
jala.BitTorrent.bdecode = <span class="reserved">function</span>(code) {
   var DICTIONARY = <span class="literal">"d"</span>;
   var LIST       = <span class="literal">"l"</span>;
   var INTEGER    = <span class="literal">"i"</span>;
   var STRING     = <span class="literal">"s"</span>;
   var END        = <span class="literal">"e"</span>;

   var stack = [];
   var overflowCounter = 0;

   var position = -1, current;

   <span class="reserved">function</span> getResult() {
      update();
      var result;
      switch (current) {
         case DICTIONARY:
            result = bdecodeDictionary();
            break;
         case LIST:
            result = bdecodeList();
            break;
         case INTEGER:
            result = bdecodeInteger();
            break;
         case END:
         case null:
            <span class="comment">//res.debug("*** end detected in getResult()");</span>
            break;
         default:
            result = bdecodeString();               
      }
      <span class="reserved">return</span> result;
   }

   <span class="reserved">function</span> update() {
      position += 1;
      current = code.charAt(position);
      <span class="comment">/* res.debug("stack: " + stack);
      res.debug("position: " + position);
      res.debug("current: " + current);
      res.debug("remains: " + code.substr(position)); */</span>
      <span class="reserved">return</span>;
   }

   <span class="reserved">function</span> overflow() {
      <span class="reserved">if</span> (overflowCounter++ &gt; 100)
         throw Error(<span class="literal">"Error parsing bdecoded string"</span>);
      <span class="reserved">return</span> false;
   }

   <span class="reserved">function</span> bdecodeDictionary() {
      stack.push(DICTIONARY);
      var dictionary = {}, key, value;
      <span class="reserved">while</span> (current &amp;&amp; !overflow()) {
         key = getResult();
         value = getResult();
         <span class="reserved">if</span> (key &amp;&amp; value)
            dictionary[key] = value;
         <span class="reserved">else</span>
            break;
      }
      stack.pop();
      <span class="reserved">return</span> dictionary;
   }

   <span class="reserved">function</span> bdecodeList() {
      stack.push(LIST);
      var list = [], value;
      <span class="reserved">while</span> (current &amp;&amp; !overflow()) {
         var value = getResult();
         <span class="reserved">if</span> (value)
            list.push(value);
         <span class="reserved">else</span>
            break;
      }
      stack.pop();
      <span class="reserved">return</span> list;
   }

   <span class="reserved">function</span> bdecodeInteger() {
      var integer = <span class="literal">""</span>;
      stack.push(integer);
      <span class="reserved">while</span> (current &amp;&amp; !overflow()) {
         update();
         <span class="reserved">if</span> (current == <span class="literal">"e"</span>)
            break;
         integer += current;
      }
      <span class="reserved">if</span> (isNaN(integer))
         throw(<span class="literal">"Error in bdecoded integer: "</span> + integer + <span class="literal">" is not a number"</span>);
      <span class="comment">//res.debug("integer = " + integer);</span>
      stack.pop();
      <span class="reserved">return</span> parseInt(integer);
   }

   <span class="reserved">function</span> bdecodeString() {
      var length = current, string = <span class="literal">""</span>;
      stack.push(string);
      update();
      <span class="reserved">while</span> (current &amp;&amp; current != <span class="literal">":"</span> &amp;&amp; !overflow()) {
         length += current;
         update();
      }
      <span class="reserved">if</span> (isNaN(length))
         throw(<span class="literal">"Error in bdecoded string: invalid length "</span> + length);
      <span class="comment">//res.debug("length = " + length);</span>
      length = parseInt(length);
      <span class="reserved">if</span> (length &gt; code.length - position)
         throw Error(<span class="literal">"Error parsing bdecoded string"</span>);
      <span class="reserved">for</span> (var i=0; i&lt;length; i+=1) {
         update();
         string += current;
      }
      <span class="comment">//res.debug("string = " + string);</span>
      <span class="reserved">if</span> (string == <span class="literal">"creation date"</span>)
         void(null);
      stack.pop();
      <span class="reserved">return</span> string;
   }

   <span class="reserved">return</span> getResult();
};
</pre>
	<hr>



<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> <font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top"><em>
<b>Jala 1.0</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<font size="-1">

</font>
<div class="jsdoc_ctime">Documentation generated by <a href="http://jsdoc.sourceforge.net/" target="_parent">JSDoc</a> on Wed Apr  4 17:06:49 2007</div>
</body>
</html>
