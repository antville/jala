<!doctype html public "-//W3C//DTD HTML 4.0 Frameset//EN""http://www.w3.org/TR/REC-html40/frameset.dtd">
<html>
<head>
<title>
Jala 1.0 Overview
</title>
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script>
function asd() {
	
		parent.document.title="Database.js Overview";
	
}
</script>
</head>
<body bgcolor="white" onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> 	<font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top">
<em>
<b>Jala 1.0</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<center>
	
	   <h2>Database.js</h2>
	
</center>

	


<h4>Summary</h4>
<p>
	
		Fields and methods of the jala.db package.<BR/><BR/>
	
</p>

<hr>


    <table border="1" cellpadding="3" cellspacing="0" width="100%">
    <tr bgcolor="#CCCCFF" class="TableHeadingColor">
    <td colspan=2><font size="+2">
    
        <b>Class Summary</b>
    
    </font></td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="jala.db.DataType.html">jala.db.DataType</a></b></td>
    <td>Instances of this class represent a data type.</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="jala.db.FileDatabase.html">jala.db.FileDatabase</a></b></td>
    <td>Instances of this class represent a file based in-process database
 <br /><strong>Important:</strong> You need the hsqldb.jar in lib/ext
 of your helma installation for this library to work, which you can get
 at http://hsqldb.org/.</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="jala.db.RamDatabase.html">jala.db.RamDatabase</a></b></td>
    <td>Instances of this class represent an in-memory sql database.</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="jala.db.Server.html">jala.db.Server</a></b></td>
    <td>Instances of this class represent a HSQLDB database server
 hosting up to 10 separate databases, which are accessible via network.</td>
    </tr>
    
    </table>
    <hr/> 


<!-- ========== METHOD SUMMARY =========== -->

<!-- ========== END METHOD SUMMARY =========== -->


        <pre class="sourceview"><span class="comment">/**
 * <span class="attrib">@fileoverview</span> Fields and methods of the jala.db package.
 */</span>


<span class="comment">// Define the global namespace for Jala modules</span>
<span class="reserved">if</span> (!global.jala) {
   global.jala = {};
}

<span class="comment">/**
 * HelmaLib dependencies
 */</span>
app.addRepository(<span class="literal">"modules/helma/Database.js"</span>);

<span class="comment">/**
 * Namespace declaration
 */</span>
jala.db = {};

<span class="comment">/**
 * Static helper method that converts the object passed as argument
 * to a connection property string.
 * <span class="attrib">@param</span> {Object} props The property object to convert
 * <span class="attrib">@returns</span> A connection property string
 * <span class="attrib">@type</span> String
 * <span class="attrib">@private</span>
 */</span>
jala.db.getPropertyString = <span class="reserved">function</span>(props) {
   <span class="reserved">if</span> (props != null) {
      res.push();
      <span class="reserved">for</span> (var i in props) {
         res.write(<span class="literal">";"</span>);
         res.write(i);
         res.write(<span class="literal">"="</span>);
         res.write(props[i]);
      }
      <span class="reserved">return</span> res.pop();
   }
   <span class="reserved">return</span> null;
}



<span class="comment">/*****************************************
 ***   D A T A B A S E   S E R V E R   ***
 *****************************************/</span>


<span class="comment">/**
 * Returns a new Server instance.
 * <span class="attrib">@class</span> Instances of this class represent a HSQLDB database server
 * hosting up to 10 separate databases, which are accessible via network.
 * &lt;br /&gt;&lt;strong&gt;Important:&lt;/strong&gt; You need the hsqldb.jar in lib/ext
 * of your helma installation for this library to work, which you can get
 * at http://hsqldb.org/.
 * <span class="attrib">@param</span> {String|Number} address Either the IP address or the port number or a combination
 * of both in the form "ip:port". By default the IP address is "127.0.0.1" (aka localhost)
 * and the port is 9001.
 * <span class="attrib">@returns</span> A newly created Server instance
 * <span class="attrib">@constructor</span>
 */</span>
jala.db.Server = <span class="reserved">function</span>(address) {

   <span class="comment">/**
    * Private variable containing the hsqldb server instance
    * <span class="attrib">@type</span> Packages.org.hsqldb.Server
    * <span class="attrib">@private</span>
    */</span>
   var server = new Packages.org.hsqldb.Server();

   <span class="comment">/**
    * Private array containing the databases within this server.
    * The index position of a database in this array corresponds
    * to the index position within the wrapped server.
    * <span class="attrib">@private</span>
    */</span>
   var databases = [];

   <span class="comment">/**
    * Map containing the names of databases pointing
    * to the index of the database within the server
    * <span class="attrib">@private</span>
    */</span>
   var names = {};

   <span class="comment">/**
    * Returns the wrapped database server instance
    * <span class="attrib">@returns</span> The wrapped database server
    * <span class="attrib">@type</span> org.hsqldb.Server
    * <span class="attrib">@private</span>
    */</span>
   <span class="reserved">this</span>.getServer = <span class="reserved">function</span>() {
      <span class="reserved">return</span> server;
   };

   <span class="comment">/**
    * Returns the database with the given name.
    * <span class="attrib">@param</span> {String} name The name of the database to return
    * <span class="attrib">@returns</span> The database with the given name
    * <span class="attrib">@type</span> jala.db.RamDatabase
    * <span class="attrib">@private</span>
    */</span>
   <span class="reserved">this</span>.getDatabase = <span class="reserved">function</span>(name) {
      var dbIdx;
      <span class="reserved">if</span> ((dbIdx = names[name]) != null) {
         <span class="reserved">return</span> databases[dbIdx];
      }
      <span class="reserved">return</span> null;
   };

   <span class="comment">/**
    * Returns the map containing the database names registered
    * within this server instance.
    * <span class="attrib">@returns</span> A map containing the database names as properties which
    * value is the index position of the database within this server
    * <span class="attrib">@type</span> Object
    * <span class="attrib">@private</span>
    */</span>
   <span class="reserved">this</span>.getDatabaseMap = <span class="reserved">function</span>() {
      <span class="reserved">return</span> names;
   };

   <span class="comment">/**
    * Returns an array containing all databases within this server.
    * <span class="attrib">@returns</span> All databases within this server
    * <span class="attrib">@type</span> Array
    * <span class="attrib">@private</span>
    */</span>
   <span class="reserved">this</span>.getDatabases = <span class="reserved">function</span>() {
      <span class="reserved">return</span> databases;
   };

   <span class="comment">/**
    * Main constructor body
    */</span>
   var ip = <span class="literal">"127.0.0.1"</span>;
   var port = 9001;
   <span class="reserved">if</span> (address != null) {
      <span class="reserved">if</span> (address.indexOf(<span class="literal">":"</span>) &gt; -1) {
         ip = address.substring(0, address.indexOf(<span class="literal">":"</span>));
         port = parseInt(address.substring(address.indexOf(<span class="literal">":"</span>) + 1), 10);
      } <span class="reserved">else</span> <span class="reserved">if</span> (!isNaN(address)) {
         port = parseInt(address, 10);
      }
   }
   <span class="comment">// set the IP address and the port this server should listen on</span>
   server.setAddress(ip);
   server.setPort(port);
   app.logger.info(<span class="literal">"Jala : created instance listening on "</span> + ip + <span class="literal">":"</span> + port);
   <span class="reserved">return</span> <span class="reserved">this</span>;
};

<span class="comment">/** <span class="attrib">@ignore</span> */</span>
jala.db.Server.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
   <span class="reserved">return</span> <span class="literal">"[Jala Database Server]"</span>;
};

<span class="comment">/**
 * Starts the database server. This should be called after all databases
 * have been added.
 * <span class="attrib">@see</span> #addDatabase
 */</span>
jala.db.Server.<span class="reserved">prototype</span>.start = <span class="reserved">function</span>() {
   var server = <span class="reserved">this</span>.getServer();
   server.setLogWriter(null);
   server.setErrWriter(null);
   server.start();
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Stops the database server.
 */</span>
jala.db.Server.<span class="reserved">prototype</span>.stop = <span class="reserved">function</span>() {
   var server = <span class="reserved">this</span>.getServer();
   server.stop();
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Returns true if the database server is running.
 * <span class="attrib">@returns</span> True if the database server is running
 * <span class="attrib">@type</span> Boolean
 */</span>
jala.db.Server.<span class="reserved">prototype</span>.isRunning = <span class="reserved">function</span>() {
   <span class="reserved">return</span> <span class="reserved">this</span>.getServer().getState() == Packages.org.hsqldb.ServerConstants.SERVER_STATE_ONLINE;
};

<span class="comment">/**
 * Adds a database to this server.
 * <span class="attrib">@param</span> {jala.db.RamDatabase} db The database to add
 * <span class="attrib">@param</span> {Object} props An optional parameter object containing database
 * properties
 */</span>
jala.db.Server.<span class="reserved">prototype</span>.addDatabase = <span class="reserved">function</span>(db, props) {
   <span class="reserved">if</span> (!(db instanceof jala.db.RamDatabase)) {
      throw <span class="literal">"jala.db.Server: Invalid argument to addDatabase(): "</span> + db;
   }
   var name = db.getName();
   var map = <span class="reserved">this</span>.getDatabaseMap();
   <span class="reserved">if</span> (map[name] != null) {
      throw <span class="literal">"jala.db.Server: There is already a database registered with the name '"</span> +
             name + <span class="literal">"'"</span>;
   }
   var server = <span class="reserved">this</span>.getServer();
   var databases = <span class="reserved">this</span>.getDatabases();
   var dbIdx = databases.length;
   var dbPath = db.getDatabasePath();
   dbPath += <span class="literal">";sql.enforce_strict_size=true"</span>;
   <span class="reserved">if</span> (props != null) {
      dbPath += jala.db.getPropertyString(props);
   }
   <span class="reserved">this</span>.getDatabaseMap()[name] = dbIdx;
   <span class="reserved">this</span>.getDatabases()[dbIdx] = db;
   <span class="comment">// add the database to the server</span>
   server.setDatabaseName(dbIdx, name);
   server.setDatabasePath(dbIdx, dbPath);
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Returns the JDBC Url to use for connections to the
 * specified database.
 * <span class="attrib">@param</span> {String} name An optional name of a database running
 * <span class="attrib">@param</span> {Object} props Optional connection properties to add
 * <span class="attrib">@returns</span> The JDBC Url to use for connecting to a database
 * within this sever
 * <span class="attrib">@type</span> String
 */</span>
jala.db.Server.<span class="reserved">prototype</span>.getUrl = <span class="reserved">function</span>(name, props) {
   <span class="reserved">if</span> (!<span class="reserved">this</span>.getDatabase(name)) {
      throw <span class="literal">"jala.db.Server: database '"</span> + name + <span class="literal">"' doesn't exist"</span>;
   }
   res.push();
   res.write(<span class="literal">"jdbc:hsqldb:hsql://localhost:"</span>);
   res.write(<span class="reserved">this</span>.getServer().getPort());
   res.write(<span class="literal">"/"</span>);
   <span class="reserved">if</span> (name != null) {
      res.write(name);
   }
   res.write(jala.db.getPropertyString(props))
   <span class="reserved">return</span> res.pop();
};

<span class="comment">/**
 * Returns a properties object containing the connection properties
 * of the database with the given name.
 * <span class="attrib">@param</span> {String} name The name of the database
 * <span class="attrib">@param</span> {Object} props An optional parameter object containing
 * connection properties to add to the connection Url.
 * <span class="attrib">@returns</span> A properties object containing the connection properties
 * <span class="attrib">@type</span> helma.util.ResourceProperties
 */</span>
jala.db.Server.<span class="reserved">prototype</span>.getProperties = <span class="reserved">function</span>(name, props) {
   <span class="reserved">if</span> (!<span class="reserved">this</span>.getDatabase(name)) {
      throw <span class="literal">"jala.db.Server: database '"</span> + name + <span class="literal">"' doesn't exist"</span>;
   }
   var rp = new Packages.helma.util.ResourceProperties();
   rp.put(name + <span class="literal">".url"</span>, <span class="reserved">this</span>.getUrl(name, props));
   rp.put(name + <span class="literal">".driver"</span>, <span class="literal">"org.hsqldb.jdbcDriver"</span>);
   rp.put(name + <span class="literal">".user"</span>, <span class="literal">"sa"</span>);
   rp.put(name + <span class="literal">".password"</span>, <span class="literal">""</span>);
   <span class="reserved">return</span> rp;
};

<span class="comment">/**
 * Returns a connection to a database within this server.
 * <span class="attrib">@param</span> {String} name The name of the database running
 * within this server
 * <span class="attrib">@param</span> {Object} props An optional parameter object
 * containing connection properties to add to the connection Url.
 * <span class="attrib">@returns</span> A connection to the specified database
 * <span class="attrib">@type</span> helma.Database
 */</span>
jala.db.Server.<span class="reserved">prototype</span>.getConnection = <span class="reserved">function</span>(name, props) {
   var rp = <span class="reserved">this</span>.getProperties(name, props);
   var dbSource = new Packages.helma.objectmodel.db.DbSource(name, rp);
   <span class="reserved">return</span> new helma.Database(dbSource);
};



<span class="comment">/*****************************
 ***   D A T A   T Y P E   ***
 *****************************/</span>


<span class="comment">/**
 * Returns a newly created DataType instance.
 * <span class="attrib">@class</span> Instances of this class represent a data type. Each instance
 * contains the code number as defined in java.sql.Types, the name of
 * the data type as defined in java.sql.Types and optional creation parameters
 * allowed for this data type.
 * <span class="attrib">@param</span> {Number} type The sql code number of this data type
 * <span class="attrib">@param</span> {String} typeName The type name of this data type, as used within sql statements
 * <span class="attrib">@param</span> {String} params Optional creation parameters allowed for this data type.
 * <span class="attrib">@returns</span> A newly created instance of DataType.
 * <span class="attrib">@constructor</span>
 */</span>
jala.db.DataType = <span class="reserved">function</span>(type, typeName, params) {

   <span class="comment">/**
    * Returns the sql type code number as defined in java.sql.Types
    * <span class="attrib">@returns</span> The sql type code number of this data type
    * <span class="attrib">@type</span> Number
    */</span>
   <span class="reserved">this</span>.getType = <span class="reserved">function</span>() {
      <span class="reserved">return</span> type;
   };

   <span class="comment">/**
    * Returns the type name of this data type, which can be
    * used in sql queries.
    * <span class="attrib">@returns</span> The type name of this data type
    * <span class="attrib">@type</span> String
    */</span>
   <span class="reserved">this</span>.getTypeName = <span class="reserved">function</span>() {
      <span class="reserved">return</span> typeName;
   };

   <span class="comment">/**
    * Returns the creation parameter string of this data type
    * <span class="attrib">@returns</span> The creation parameter string of this data type
    * <span class="attrib">@type</span> String
    */</span>
   <span class="reserved">this</span>.getParams = <span class="reserved">function</span>() {
      <span class="reserved">return</span> params;
   };
   
   <span class="comment">/** <span class="attrib">@ignore</span> */</span>
   <span class="reserved">this</span>.toString = <span class="reserved">function</span>() {
      <span class="reserved">return</span> <span class="literal">"[DataType "</span> +
             <span class="literal">" CODE: "</span> + code +
             <span class="literal">", SQL: "</span> + sqlType +
             <span class="literal">", PARAMS: "</span> + params + <span class="literal">"]"</span>;
   };

   <span class="reserved">return</span> <span class="reserved">this</span>;
};

<span class="comment">/**
 * Returns true if values for this data type should be surrounded
 * by (single) quotes.
 * <span class="attrib">@returns</span> True if values for this data type should be surrounded
 * by quotes, false if not
 * <span class="attrib">@type</span> Boolean
 */</span>
jala.db.DataType.<span class="reserved">prototype</span>.needsQuotes = <span class="reserved">function</span>() {
   switch (<span class="reserved">this</span>.getType()) {
      case java.sql.Types.CHAR:
      case java.sql.Types.VARCHAR:
      case java.sql.Types.LONGVARCHAR:
      case java.sql.Types.BINARY:
      case java.sql.Types.VARBINARY:
      case java.sql.Types.LONGVARBINARY:
      case java.sql.Types.DATE:
      case java.sql.Types.TIME:
      case java.sql.Types.TIMESTAMP:
         <span class="reserved">return</span> true;
      default:
         <span class="reserved">return</span> false;
   }
};



<span class="comment">/***********************************
 ***   R A M   D A T A B A S E   ***
 ***********************************/</span>


<span class="comment">/**
 * Returns a newly created RamDatabase instance.
 * <span class="attrib">@class</span> Instances of this class represent an in-memory sql database.
 * &lt;br /&gt;&lt;strong&gt;Important:&lt;/strong&gt; You need the hsqldb.jar in lib/ext
 * of your helma installation for this library to work, which you can get
 * at http://hsqldb.org/.
 * <span class="attrib">@param</span> {String} name The name of the database
 * <span class="attrib">@returns</span> A newly created instance of RamDatabase
 * <span class="attrib">@constructor</span>
 */</span>
jala.db.RamDatabase = <span class="reserved">function</span>(name) {

   <span class="comment">/**
    * Returns the name of the database
    * <span class="attrib">@returns</span> The name of the database
    * <span class="attrib">@type</span> String
    */</span>
   <span class="reserved">this</span>.getName = <span class="reserved">function</span>() {
      <span class="reserved">return</span> name;
   };

   <span class="reserved">return</span>;
};

<span class="comment">/** <span class="attrib">@ignore</span> */</span>
jala.db.RamDatabase.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
   <span class="reserved">return</span> <span class="literal">"[Jala RamDatabase "</span> + <span class="reserved">this</span>.getName() + <span class="literal">"]"</span>;
}

<span class="comment">/**
 * Returns the JDBC Url to connect to this database
 * <span class="attrib">@param</span> {Object} props Optional connection properties to add
 * <span class="attrib">@returns</span> The JDBC url to use for connecting to this database
 * <span class="attrib">@type</span> String
 */</span>
jala.db.RamDatabase.<span class="reserved">prototype</span>.getUrl = <span class="reserved">function</span>(props) {
   var url = <span class="literal">"jdbc:hsqldb:"</span> + <span class="reserved">this</span>.getDatabasePath();
   <span class="reserved">if</span> (props != null) {
      url += jala.db.getPropertyString(props);
   }
   <span class="reserved">return</span> url;
};

<span class="comment">/**
 * Returns the path of this database, which is used by jala.db.Server
 * when adding the database to its set of hosted databases.
 * <span class="attrib">@returns</span> The path of this database within a server instance
 * <span class="attrib">@type</span> String
 * <span class="attrib">@private</span>
 */</span>
jala.db.RamDatabase.<span class="reserved">prototype</span>.getDatabasePath = <span class="reserved">function</span>() {
   <span class="reserved">return</span> <span class="literal">"mem:"</span> + <span class="reserved">this</span>.getName();
}

<span class="comment">/**
 * Returns a properties object containing the connection properties
 * for this database.
 * <span class="attrib">@param</span> {Object} props An optional parameter object containing
 * connection properties to add to the connection Url.
 * <span class="attrib">@returns</span> A properties object containing the connection properties
 * <span class="attrib">@type</span> helma.util.ResourceProperties
 */</span>
jala.db.RamDatabase.<span class="reserved">prototype</span>.getProperties = <span class="reserved">function</span>(props) {
   var name = <span class="reserved">this</span>.getName();
   var rp = new Packages.helma.util.ResourceProperties();
   rp.put(name + <span class="literal">".url"</span>, <span class="reserved">this</span>.getUrl(props));
   rp.put(name + <span class="literal">".driver"</span>, <span class="literal">"org.hsqldb.jdbcDriver"</span>);
   rp.put(name + <span class="literal">".user"</span>, <span class="literal">"sa"</span>);
   rp.put(name + <span class="literal">".password"</span>, <span class="literal">""</span>);
   <span class="reserved">return</span> rp;
};

<span class="comment">/**
 * Returns a connection to this database
 * <span class="attrib">@param</span> {Object} An optional parameter object containing connection
 * properties to add to the connection Url.
 * <span class="attrib">@returns</span> A connection to this database
 * <span class="attrib">@type</span> helma.Database
 */</span>
jala.db.RamDatabase.<span class="reserved">prototype</span>.getConnection = <span class="reserved">function</span>(props) {
   var name = <span class="reserved">this</span>.getName();
   var rp = <span class="reserved">this</span>.getProperties(props);
   var dbSource = new Packages.helma.objectmodel.db.DbSource(name, rp);
   <span class="reserved">return</span> new helma.Database(dbSource);
};

<span class="comment">/**
 * Stops this in-process database by issueing a "SHUTDOWN" sql command.
 */</span>
jala.db.RamDatabase.<span class="reserved">prototype</span>.shutdown = <span class="reserved">function</span>() {
   var conn = <span class="reserved">this</span>.getConnection();
   conn.execute(<span class="literal">"SHUTDOWN"</span>);
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Creates a table in this database.
 * <span class="attrib">@param</span> {String} name The name of the table
 * <span class="attrib">@param</span> {Array} columns The columns to create in the table. Each column
 * must be described using an object containing the following properties:
 * &lt;ul&gt;
 * &lt;li&gt;name (String): The name of the column&lt;/li&gt;
 * &lt;li&gt;type (Number): The type of the column as defined in java.sql.Types&lt;/li&gt;
 * &lt;li&gt;nullable (Boolean): If true the column may contain null values (optional, defaults to true)&lt;/li&gt;
 * &lt;li&gt;length (Number): The maximum length of the column (optional)&lt;/li&gt;
 * &lt;li&gt;precision (Number): The precision to use (optional)&lt;/li&gt;
 * &lt;li&gt;unique (Boolean): If true the column may only contain unique values (optional, defaults to false)&lt;/li&gt;
 * &lt;li&gt;default (Object): The default value to use (optional)&lt;/li&gt;
 * &lt;/ul&gt;
 * <span class="attrib">@param</span> {String} primaryKey The name of the column that contains
 * the primary key
 */</span>
jala.db.RamDatabase.<span class="reserved">prototype</span>.createTable = <span class="reserved">function</span>(tableName, columns, primaryKey) {
   res.push();
   res.write(<span class="literal">"CREATE TABLE "</span>);
   res.write(tableName);
   res.write(<span class="literal">" ("</span>);
   var column, dataType, params;
   <span class="reserved">for</span> (var i=0;i&lt;columns.length;i++) {
      column = columns[i];
      res.write(column.name);
      res.write(<span class="literal">" "</span>);
      dataType = <span class="reserved">this</span>.getDataType(column.type);
      <span class="reserved">if</span> (!dataType) {
         throw <span class="literal">"Unable to determine data type, code: "</span> + column.type;
      }
      res.write(dataType.getTypeName());
      <span class="reserved">if</span> ((params = dataType.getParams()) != null) {
         var arr = [];
         switch (params.toLowerCase()) {
            case <span class="literal">"length"</span>:
               <span class="reserved">if</span> (column.length) {
                  arr.push(column.length);
               }
               break;
            case <span class="literal">"precision"</span>:
               <span class="reserved">if</span> (column.precision) {
                  arr.push(column.precision);
               }
               break;
            case <span class="literal">"precision,scale"</span>:
               <span class="reserved">if</span> (column.precision) {
                  arr.push(column.precision);
               }
               <span class="reserved">if</span> (column.scale) {
                  arr.push(column.scale);
               }
               break;
         }
         <span class="reserved">if</span> (arr.length &gt; 0) {
            res.write(<span class="literal">"("</span>);
            res.write(arr.join(<span class="literal">","</span>));
            res.write(<span class="literal">")"</span>);
         }
      }
      <span class="reserved">if</span> (column[<span class="literal">"default"</span>]) {
         res.write(<span class="literal">" DEFAULT "</span>);
         <span class="reserved">if</span> (dataType.needsQuotes() === true) {
            res.write(<span class="literal">"'"</span>);
            res.write(column[<span class="literal">"default"</span>]);
            res.write(<span class="literal">"'"</span>);
         } <span class="reserved">else</span> {
            res.write(column[<span class="literal">"default"</span>]);
         }
      }
      <span class="reserved">if</span> (column.nullable === false) {
         res.write(<span class="literal">" NOT NULL"</span>);
      }
      <span class="reserved">if</span> (i &lt; columns.length - 1) {
         res.write(<span class="literal">", "</span>);
      }
   }
   <span class="reserved">if</span> (primaryKey != null) {
      res.write(<span class="literal">", PRIMARY KEY ("</span>);
      <span class="reserved">if</span> (primaryKey instanceof Array) {
         res.write(primaryKey.join(<span class="literal">", "</span>));
      } <span class="reserved">else</span> {
         res.write(primaryKey);
      }
      res.write(<span class="literal">")"</span>);
   }
   res.write(<span class="literal">")"</span>);
   var sql = res.pop();
   try {
      var conn = <span class="reserved">this</span>.getConnection();
      conn.execute(sql);
      app.logger.info(<span class="literal">"Successfully created table "</span> + tableName);
      app.logger.debug(<span class="literal">"Sql statement used: "</span> + sql);
      <span class="reserved">return</span> true;
   } catch (e) {
      app.logger.error(<span class="literal">"Unable to create table "</span> + tableName + <span class="literal">", reason: "</span> + e);
      <span class="reserved">return</span> false;
   }
};

<span class="comment">/**
 * Drops the table with the given name
 * <span class="attrib">@param</span> {String} tableName The name of the table
 * <span class="attrib">@returns</span> True if the table was successfully dropped, false otherwise
 * <span class="attrib">@type</span> Boolean
 */</span>
jala.db.RamDatabase.<span class="reserved">prototype</span>.dropTable = <span class="reserved">function</span>(tableName) {
   var conn = <span class="reserved">this</span>.getConnection();
   var sql = <span class="literal">"DROP TABLE "</span> + tableName;
   conn.execute(sql);
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Returns true if the table exists already in the database
 * <span class="attrib">@param</span> {String} name The name of the table
 * <span class="attrib">@returns</span> True if the table exists, false otherwise
 * <span class="attrib">@type</span> Boolean
 */</span>
jala.db.RamDatabase.<span class="reserved">prototype</span>.tableExists = <span class="reserved">function</span>(name) {
   var conn = <span class="reserved">this</span>.getConnection().getConnection();
   var meta = conn.getMetaData();
   var t = meta.getTables(null, <span class="literal">"PUBLIC"</span>, <span class="literal">"%"</span>, null);
   var tableName;
   try {
      <span class="reserved">while</span> (t.next()) {
         tableName = t.getString(3).toUpperCase();
         <span class="reserved">if</span> (tableName.toLowerCase() === name.toLowerCase()) {
            <span class="reserved">return</span> true;
         }
      }
      <span class="reserved">return</span> false;
   } finally {
      <span class="reserved">if</span> (t != null) {
         t.close();
      }
      <span class="reserved">if</span> (conn != null) {
         conn.close();
      }
   }
};

<span class="comment">/**
 * Copies all tables in the database passed as argument into this embedded database.
 * If any of the tables already exists in this database, they will be removed before
 * re-created. Please mind that this method ignores any indexes in the source database,
 * but respects the primary key settings.
 * <span class="attrib">@param</span> {helma.Database} database The database to copy the tables from
 */</span>
jala.db.RamDatabase.<span class="reserved">prototype</span>.copyTables = <span class="reserved">function</span>(database) {
   <span class="comment">// retrieve the metadata for all tables in this schema</span>
   try {
      var conn = database.getConnection();
      var meta = conn.getMetaData();
      var t = meta.getTables(null, <span class="literal">"%"</span>, <span class="literal">"%"</span>, null);
      var tableName, columns;
      <span class="reserved">while</span> (t.next()) {
         tableName = t.getString(3).toUpperCase();
         <span class="reserved">if</span> (<span class="reserved">this</span>.tableExists(tableName)) {
            <span class="reserved">this</span>.dropTable(tableName);
         }
         <span class="comment">// create an array containing the necessary column metadata</span>
         var columns = [];
         var c = meta.getColumns(null, <span class="literal">"%"</span>, tableName, <span class="literal">"%"</span>);
         var columnName, columnType, columnTypeName, columnSize, columnNullable;
         <span class="reserved">while</span> (c.next()) {
            columns[columns.length] = {
               name: c.getString(4),
               type: c.getInt(5),
               length: c.getInt(7),
               nullable: (c.getInt(11) == meta.typeNoNulls) ? false : true,
               <span class="literal">"default"</span>: c.getString(13),
               precision: c.getInt(9),
               scale: c.getInt(10)
            }
         }
   
         <span class="comment">// retrieve the primary keys of the table</span>
         var pk = meta.getPrimaryKeys(null, <span class="literal">"%"</span>, tableName);
         var keys = [];
         <span class="reserved">while</span> (pk.next()) {
            keys[keys.length] = pk.getString(4);
         }
         <span class="comment">// create the table in the embedded database</span>
         <span class="reserved">this</span>.createTable(tableName, columns, keys.length &gt; 0 ? keys : null);
      }
   } finally {
      <span class="reserved">if</span> (t != null) {
         t.close();
      }
      <span class="reserved">if</span> (conn != null) {
         conn.close();
      }
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Returns an array containing all available data types.
 * <span class="attrib">@returns</span> All available data types
 * <span class="attrib">@type</span> Array
 * <span class="attrib">@see</span> jala.db.DataType
 */</span>
jala.db.RamDatabase.<span class="reserved">prototype</span>.getDataTypes = <span class="reserved">function</span>() {
   <span class="comment">// data types are cached for performance reasons</span>
   <span class="reserved">if</span> (!arguments.callee.cache) {
      <span class="comment">// java.sql data types</span>
      arguments.callee.cache = [];
      var con = <span class="reserved">this</span>.getConnection().getConnection();
      var meta = con.getMetaData();
      var rs = meta.getTypeInfo();
      var code, name, params;
      <span class="reserved">while</span> (rs.next()) {
         code = rs.getInt(<span class="literal">"DATA_TYPE"</span>);
         name = rs.getString(<span class="literal">"TYPE_NAME"</span>);
         params = rs.getString(<span class="literal">"CREATE_PARAMS"</span>);
         arguments.callee.cache.push(new jala.db.DataType(code, name, params));
      }
   }
   <span class="reserved">return</span> arguments.callee.cache;
};

<span class="comment">/**
 * Returns the data type for the code passed as argument
 * <span class="attrib">@param</span> {Number} type The type code as defined in java.sql.Types
 * <span class="attrib">@returns</span> The data type object for the code
 * <span class="attrib">@type</span> jala.db.DataType
 */</span>
jala.db.RamDatabase.<span class="reserved">prototype</span>.getDataType = <span class="reserved">function</span>(type) {
   var types = <span class="reserved">this</span>.getDataTypes();
   var dataType;
   <span class="reserved">for</span> (var i=0;i&lt;types.length;i++) {
      dataType = types[i];
      <span class="reserved">if</span> (dataType.getType() === type) {
         <span class="reserved">return</span> dataType;
      }
   }
   <span class="reserved">return</span> null;
};

<span class="comment">/**
 * Runs the script file passed as argument in the context of this database.
 * Use this method to eg. create and/or populate a database.
 * <span class="attrib">@param</span> {helma.File} file The script file to run.
 */</span>
jala.db.RamDatabase.<span class="reserved">prototype</span>.runScript = <span class="reserved">function</span>(file) {
   try {
      var sqlFile = new Packages.org.hsqldb.util.SqlFile(new java.io.File(file), false, new java.util.HashMap());
      var conn = <span class="reserved">this</span>.getConnection().getConnection();
      sqlFile.execute(conn, false);
      app.logger.info(<span class="literal">"Jala Database: successfully executed SQL script '"</span> + file.getAbsolutePath() + <span class="literal">"'"</span>);
      <span class="reserved">return</span> true;
   } catch (e) {
      app.logger.error(<span class="literal">"Jala Database: executing SQL script failed, reason: "</span> + e);
      <span class="reserved">return</span> false;
   } finally {
      <span class="reserved">if</span> (conn != null) {
         conn.close();
      }
   }
};



<span class="comment">/*************************************
 ***   F I L E   D A T A B A S E   ***
 *************************************/</span>


<span class="comment">/**
 * Returns a newly created instance of FileDatabase.
 * <span class="attrib">@class</span> Instances of this class represent a file based in-process database
 * &lt;br /&gt;&lt;strong&gt;Important:&lt;/strong&gt; You need the hsqldb.jar in lib/ext
 * of your helma installation for this library to work, which you can get
 * at http://hsqldb.org/.
 * <span class="attrib">@param</span> {String} name The name of the database
 * <span class="attrib">@param</span> {helma.File} directory The directory where the database files
 * should be stored in.
 * <span class="attrib">@returns</span> A newly created FileDatabase instance
 * <span class="attrib">@constructor</span>
 */</span>
jala.db.FileDatabase = <span class="reserved">function</span>(name, directory) {

   <span class="comment">/**
    * Returns the name of the database
    * <span class="attrib">@returns</span> The name of the database
    * <span class="attrib">@type</span> String
    */</span>
   <span class="reserved">this</span>.getName = <span class="reserved">function</span>() {
      <span class="reserved">return</span> name;
   };

   <span class="comment">/**
    * Returns the directory where the database files are stored.
    * <span class="attrib">@returns</span> The directory where the database is stored.
    * <span class="attrib">@type</span> helma.File
    */</span>
   <span class="reserved">this</span>.getDirectory = <span class="reserved">function</span>() {
      <span class="reserved">return</span> directory;
   };

   <span class="reserved">return</span> <span class="reserved">this</span>;
};
<span class="comment">// extend RamDatabase</span>
jala.db.FileDatabase.<span class="reserved">prototype</span> = new jala.db.RamDatabase();

<span class="comment">/** <span class="attrib">@ignore</span> */</span>
jala.db.FileDatabase.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
   <span class="reserved">return</span> <span class="literal">"[Jala FileDatabase "</span> + <span class="reserved">this</span>.getName() +
          <span class="literal">" ("</span> + <span class="reserved">this</span>.getDirectory().getAbsolutePath() + <span class="literal">")]"</span>;
};

<span class="comment">/**
 * Returns the path of this database, which is used when adding
 * the database to a server instance.
 * <span class="attrib">@returns</span> The path of this database within a server instance
 * <span class="attrib">@type</span> String
 * <span class="attrib">@private</span>
 */</span>
jala.db.FileDatabase.<span class="reserved">prototype</span>.getDatabasePath = <span class="reserved">function</span>() {
   var directory = new helma.File(<span class="reserved">this</span>.getDirectory(), <span class="reserved">this</span>.getName());
   <span class="reserved">return</span> <span class="literal">"file:"</span> + directory.getAbsolutePath();
};
</pre>
	<hr>



<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> <font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top"><em>
<b>Jala 1.0</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<font size="-1">

</font>
<div class="jsdoc_ctime">Documentation generated by <a href="http://jsdoc.sourceforge.net/" target="_parent">JSDoc</a> on Thu Mar 15 15:28:10 2007</div>
</body>
</html>
