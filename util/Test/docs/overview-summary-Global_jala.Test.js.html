<!doctype html public "-//W3C//DTD HTML 4.0 Frameset//EN""http://www.w3.org/TR/REC-html40/frameset.dtd">
<html>
<head>
<title>
Jala Test Overview
</title>
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script>
function asd() {
	
		parent.document.title="Global/jala.Test.js Overview";
	
}
</script>
</head>
<body bgcolor="white" onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> 	<font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top">
<em>
<b>Jala Test</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<center>
	
	   <h2>Global/jala.Test.js</h2>
	
</center>

	


<h4>Summary</h4>
<p>
	
		Fields and methods of the jala.Test class.<BR/><BR/>
	
</p>

<hr>


    <table border="1" cellpadding="3" cellspacing="0" width="100%">
    <tr bgcolor="#CCCCFF" class="TableHeadingColor">
    <td colspan=2><font size="+2">
    
        <b>Class Summary</b>
    
    </font></td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="jala.Test.html">jala.Test</a></b></td>
    <td>Provides various methods for automated tests.</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="jala.Test.ArgumentsException.html">jala.Test.ArgumentsException</a></b></td>
    <td>Instances of this exception are thrown whenever an assertion
 function is called with incorrect or insufficient arguments
 </td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="jala.Test.DatabaseMgr.html">jala.Test.DatabaseMgr</a></b></td>
    <td>Instances of this class allow managing test databases
 and switching a running application to an in-memory test
 database to use within a unit test.</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="jala.Test.EvaluatorException.html">jala.Test.EvaluatorException</a></b></td>
    <td>Instances of this exception are thrown when attempt
 to evaluate the test code fails
 </td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="jala.Test.Exception.html">jala.Test.Exception</a></b></td>
    <td>Base exception class
 </td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="jala.Test.HttpClient.html">jala.Test.HttpClient</a></b></td>
    <td>Instances of this class represent a http client useable for
 testing, as any session cookies received by the tested application
 are stored and used for subsequent requests, allowing simple "walkthrough"
 tests.</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="jala.Test.TestException.html">jala.Test.TestException</a></b></td>
    <td>Instances of this exception are thrown whenever an
 assertion function fails
 </td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="jala.Test.TestFunctionResult.html">jala.Test.TestFunctionResult</a></b></td>
    <td>Instances of this class represent the result of the successful
 execution of a single test function (failed executions will be represented
 as Exceptions in the log of a test result).</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="jala.Test.TestResult.html">jala.Test.TestResult</a></b></td>
    <td>Instances of this class represent the result of the execution
 of a single test file
 </td>
    </tr>
    
    </table>
    <hr/> 


<!-- ========== METHOD SUMMARY =========== -->

<!-- ========== END METHOD SUMMARY =========== -->


        <pre class="sourceview"><span class="comment">//</span>
<span class="comment">// Jala Project [http://opensvn.csie.org/traccgi/jala]</span>
<span class="comment">//</span>
<span class="comment">// Copyright 2004 ORF Online und Teletext GmbH</span>
<span class="comment">//</span>
<span class="comment">// Licensed under the Apache License, Version 2.0 (the ``License'');</span>
<span class="comment">// you may not use this file except in compliance with the License.</span>
<span class="comment">// You may obtain a copy of the License at</span>
<span class="comment">//</span>
<span class="comment">//    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="comment">//</span>
<span class="comment">// Unless required by applicable law or agreed to in writing, software</span>
<span class="comment">// distributed under the License is distributed on an ``AS IS'' BASIS,</span>
<span class="comment">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="comment">// See the License for the specific language governing permissions and</span>
<span class="comment">// limitations under the License.</span>
<span class="comment">//</span>
<span class="comment">// $Revision$</span>
<span class="comment">// $LastChangedBy$</span>
<span class="comment">// $LastChangedDate$</span>
<span class="comment">// $HeadURL$</span>
<span class="comment">//</span>


<span class="comment">/**
 * <span class="attrib">@fileoverview</span> Fields and methods of the jala.Test class.
 */</span>


<span class="comment">// Define the global namespace for Jala modules</span>
<span class="reserved">if</span> (!global.jala) {
   global.jala = {};
}


<span class="comment">/**
 * HelmaLib dependencies
 */</span>
app.addRepository(<span class="literal">"modules/helma/Http.js"</span>);

<span class="comment">/**
 * Jala dependencies
 */</span>
app.addRepository(<span class="literal">"modules/jala/code/Database.js"</span>);

<span class="comment">/**
 * Constructs a new Test instance.
 * <span class="attrib">@class</span> Provides various methods for automated tests.
 * This is essentially a port of JSUnit (http://www.edwardh.com/jsunit/)
 * suitable for testing Helma applications.
 * <span class="attrib">@param</span> {Number} capacity The capacity of the cache
 * <span class="attrib">@constructor</span>
 */</span>
jala.Test = <span class="reserved">function</span>() {

   <span class="comment">/**
    * Contains the number of tests that were executed
    * <span class="attrib">@type</span> Number
    */</span>
   <span class="reserved">this</span>.testsRun = 0;

   <span class="comment">/**
    * Contains the number of tests that failed
    * <span class="attrib">@type</span> Boolean
    */</span>
   <span class="reserved">this</span>.testsFailed = 0;

   <span class="comment">/**
    * Contains the number of test functions that passed
    * <span class="attrib">@type</span> Number
    */</span>
   <span class="reserved">this</span>.functionsPassed = 0;

   <span class="comment">/**
    * Contains the number of test functions that failed
    * <span class="attrib">@type</span> Number
    */</span>
   <span class="reserved">this</span>.functionsFailed = 0;

   <span class="comment">/**
    * An Array containing the results of this Test instance.
    * <span class="attrib">@type</span> Array
    */</span>
   <span class="reserved">this</span>.results = [];

   <span class="reserved">return</span> <span class="reserved">this</span>;
};



<span class="comment">/*************************************************************
 ***** S T A T I C   F I E L D S   A N D   M E T H O D S *****
 *************************************************************/</span>


<span class="comment">/**
 * Constant indicating "passed" status
 * <span class="attrib">@type</span> String
 * <span class="attrib">@final</span>
 */</span>
jala.Test.PASSED = <span class="literal">"passed"</span>;

<span class="comment">/**
 * Constant indicating "failed" status
 * <span class="attrib">@type</span> String
 * <span class="attrib">@final</span>
 */</span>
jala.Test.FAILED = <span class="literal">"failed"</span>;

<span class="comment">/**
 * Helper method useable for displaying a value
 * <span class="attrib">@param</span> {Object} The value to render
 * <span class="attrib">@returns</span> The value rendered as string
 * <span class="attrib">@type</span> String
 */</span>
jala.Test.valueToString = <span class="reserved">function</span>(val) {
   res.push();
   <span class="reserved">if</span> (val === null) {
      res.write(<span class="literal">"null"</span>);
   } <span class="reserved">else</span> <span class="reserved">if</span> (val === undefined) {
      res.write(<span class="literal">"undefined"</span>);
   } <span class="reserved">else</span> {
      <span class="reserved">if</span> (val.constructor &amp;&amp; val.constructor == String) {
         res.write(<span class="literal">'"'</span> + val.toString() + <span class="literal">'"'</span>);
      } <span class="reserved">else</span> {
         res.write(val.toString());
      }
      res.write(<span class="literal">" ("</span>);
      <span class="reserved">if</span> (val.constructor &amp;&amp; val.constructor.name != null) {
         res.write(val.constructor.name);
      } <span class="reserved">else</span> {
         res.write(typeof(val));
      }
      res.write(<span class="literal">")"</span>);
   }
   <span class="reserved">return</span> res.pop();
};

<span class="comment">/**
 * Returns the directory containing the test files.
 * The location of the directory is either defined by the
 * application property "jala.testDir" or expected to be one level
 * above the application directory (and named "tests")
 * <span class="attrib">@returns</span> The directory containing the test files
 * <span class="attrib">@type</span> helma.File
 */</span>
jala.Test.getTestsDirectory = <span class="reserved">function</span>() {
   var dir;
   <span class="reserved">if</span> (getProperty(<span class="literal">"jala.testDir"</span>) != null) {
      dir = new helma.File(getProperty(<span class="literal">"jala.testDir"</span>));
   }
   <span class="reserved">if</span> (!dir || !dir.exists()) {
      var appDir = new helma.File(app.dir);
      dir = new helma.File(appDir.getParent(), <span class="literal">"tests"</span>);
      <span class="reserved">if</span> (!dir.exists())
         <span class="reserved">return</span> null;
   }
   <span class="reserved">return</span> dir;
};

<span class="comment">/**
 * Returns an array containing the test files located
 * in the directory.
 * <span class="attrib">@returns</span> An array containing the names of all test files
 * <span class="attrib">@type</span> Array
 */</span>
jala.Test.getTestFiles = <span class="reserved">function</span>() {
   var dir;
   <span class="reserved">if</span> ((dir = jala.Test.getTestsDirectory()) != null) {
      <span class="reserved">return</span> dir.list(/.*\.js/).sort();
   }
   <span class="reserved">return</span> null;
};

<span class="comment">/**
 * Returns the testfile with the given name
 * <span class="attrib">@param</span> {String} fileName The name of the test file
 * <span class="attrib">@returns</span> The test file
 * <span class="attrib">@type</span> helma.File
 */</span>
jala.Test.getTestFile = <span class="reserved">function</span>(fileName) {
   var dir = jala.Test.getTestsDirectory();
   <span class="reserved">if</span> (dir != null) {
      <span class="reserved">return</span> new helma.File(dir, fileName);
   }
   <span class="reserved">return</span> null;
};

<span class="comment">/**
 * <span class="attrib">@param</span> {Number} nr The number of arguments to be expected
 * <span class="attrib">@param</span> {Object} args The arguments array.
 * <span class="attrib">@returns</span> True in case the number of arguments matches
 * the expected amount, false otherwise.
 * <span class="attrib">@type</span> Boolean
 */</span>
jala.Test.evalArguments = <span class="reserved">function</span>(args, argsExpected) {
   <span class="reserved">if</span> (!(args.length == argsExpected ||
             (args.length == argsExpected + 1 &amp;&amp; typeof(args[0]) == <span class="literal">"string"</span>))) {
      throw new jala.Test.ArgumentsException(<span class="literal">"Insufficient arguments passed to assertion function"</span>);
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Returns true if the arguments array passed as argument
 * contains an additional comment.
 * <span class="attrib">@param</span> {Array} args The arguments array to check for an existing comment.
 * <span class="attrib">@param</span> {Number} argsExpected The number of arguments expected by the
 * assertion function.
 * <span class="attrib">@returns</span> True if the arguments contain a comment, false otherwise.
 * <span class="attrib">@type</span> Boolean
 */</span>
jala.Test.argsContainComment = <span class="reserved">function</span>(args, argsExpected) {
   <span class="reserved">return</span> !(args.length == argsExpected
               || (args.length == argsExpected + 1 &amp;&amp; typeof(args[0]) != <span class="literal">"string"</span>))
};

<span class="comment">/**
 * Cuts out the comment from the arguments array passed
 * as argument and returns it. CAUTION: this actually modifies
 * the arguments array!
 * <span class="attrib">@param</span> {Array} args The arguments array.
 * <span class="attrib">@returns</span> The comment, if existing. Null otherwise.
 * <span class="attrib">@type</span> String
 */</span>
jala.Test.getComment = <span class="reserved">function</span>(args, argsExpected) {
   <span class="reserved">if</span> (jala.Test.argsContainComment(args, argsExpected))
      <span class="reserved">return</span> args[0];
   <span class="reserved">return</span> null;
};

<span class="comment">/**
 * Returns the argument on the index position in the array
 * passed as arguments. This method respects an optional comment
 * at the beginning of the arguments array.
 * <span class="attrib">@param</span> {Array} args The arguments to retrieve the non-comment
 * value from.
 * <span class="attrib">@param</span> {Number} idx The index position on which the value to
 * retrieve is to be expected if &lt;em&gt;no&lt;/em&gt; comment is existing.
 * <span class="attrib">@returns</span> The non-comment value, or null.
 * <span class="attrib">@type</span> Object
 */</span>
jala.Test.getValue = <span class="reserved">function</span>(args, argsExpected, idx) {
   <span class="reserved">return</span> jala.Test.argsContainComment(args, argsExpected) ? args[idx+1] : args[idx];
};


<span class="comment">/**
 * Creates a stack trace and parses it for display.
 * <span class="attrib">@param</span> {String} message The failure message
 * <span class="attrib">@returns</span> The parsed stack trace
 * <span class="attrib">@type</span> String
 */</span>
jala.Test.getStackTrace = <span class="reserved">function</span>(message) {
   <span class="comment">// store the file and line-number of the failed call</span>
   var ex = new Packages.org.mozilla.javascript.EvaluatorException(message || <span class="literal">""</span>);
   ex.fillInStackTrace();
   var trace = ex.getStackTrace();
   var el, fileName, lineNumber;
   var stack = [];
   <span class="comment">// parse the stack trace and keep only the js elements</span>
   <span class="reserved">for</span> (var i=0;i&lt;trace.length;i++) {
      el = trace[i];
      <span class="reserved">if</span> (!(fileName = el.getFileName()))
         continue;
      <span class="reserved">if</span> ((lineNumber = el.getLineNumber()) == -1)
         continue;
      <span class="reserved">if</span> (fileName.endsWith(<span class="literal">".js"</span>) || fileName.endsWith(<span class="literal">".hac"</span>) || fileName.endsWith(<span class="literal">".hsp"</span>)) {
         <span class="comment">// ignore all trace lines that refer to jala.Test</span>
         <span class="reserved">if</span> (fileName.endsWith(<span class="literal">"jala.Test.js"</span>)) {
            continue;
         }
         stack[stack.length] = <span class="literal">"at "</span> + fileName + <span class="literal">", line "</span> + lineNumber;
         <span class="reserved">if</span> (fileName.endsWith(res.meta.currentTest)) {
            break;
         }
      }
   }
   <span class="reserved">return</span> stack.join(<span class="literal">"\n"</span>);
};

<span class="comment">/**
 * Returns a custom JavaScript scope used for evaluating unit tests.
 * This method defines all assertion methods as global methods,
 * and creates a default instantiation of the Http client
 * for convenience.
 * <span class="attrib">@returns</span> The newly created scope object
 * <span class="attrib">@type</span> helma.scripting.rhino.GlobalObject
 * <span class="attrib">@private</span>
 */</span>
jala.Test.getTestScope = <span class="reserved">function</span>() {
   <span class="comment">// create a new vanilla global object</span>
   var engine = Packages.helma.scripting.rhino.RhinoEngine.getRhinoEngine();
   var scope = new Packages.helma.scripting.rhino.GlobalObject(engine.getCore(),
                         app.__app__, true);
   var framework = Packages.helma.framework;
   <span class="comment">// put the necessary global objects into the scope</span>
   scope.root = root;
   scope.session = session;
   scope.req = req;
   scope.res = res;
   scope.path = path;
   <span class="comment">// define global assertion functions</span>
   <span class="reserved">for</span> (var i in jala.Test.<span class="reserved">prototype</span>) {
      <span class="reserved">if</span> (i.indexOf(<span class="literal">"assert"</span>) == 0) {
         scope[i] = jala.Test.<span class="reserved">prototype</span>[i];
      }
   }
   <span class="comment">// instantiate a global HttpClient</span>
   scope.httpClient = new jala.Test.HttpClient();
   <span class="comment">// instantiate the test database manager</span>
   scope.testDatabases = new jala.Test.DatabaseMgr();
   <span class="reserved">return</span> scope;
}



<span class="comment">/*******************************
 ***** E X C E P T I O N S *****
 *******************************/</span>


<span class="comment">/**
 * Creates a new Exception instance
 * <span class="attrib">@class</span> Base exception class
 * <span class="attrib">@returns</span> A newly created Exception instance
 * <span class="attrib">@constructor</span>
 */</span>
jala.Test.Exception = <span class="reserved">function</span> Exception() {
   <span class="reserved">return</span> <span class="reserved">this</span>;
};

<span class="comment">/** <span class="attrib">@ignore</span> */</span>
jala.Test.Exception.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
   <span class="reserved">return</span> <span class="literal">"jala.Test.Exception: "</span> + <span class="reserved">this</span>.message + <span class="literal">"]"</span>;
};

<span class="comment">/**
 * Creates a new TestException instance
 * <span class="attrib">@class</span> Instances of this exception are thrown whenever an
 * assertion function fails
 * <span class="attrib">@param</span> {String} comment An optional comment
 * <span class="attrib">@param</span> {String} message The failure message
 * <span class="attrib">@returns</span> A newly created TestException instance
 * <span class="attrib">@constructor</span>
 */</span>
jala.Test.TestException = <span class="reserved">function</span> TestException(comment, message) {
   <span class="reserved">this</span>.functionName = null;
   <span class="reserved">this</span>.comment = comment;
   <span class="reserved">this</span>.message = message;
   <span class="reserved">this</span>.stackTrace = jala.Test.getStackTrace(message);
   <span class="reserved">return</span> <span class="reserved">this</span>;
};
jala.Test.TestException.<span class="reserved">prototype</span> = new jala.Test.Exception();

<span class="comment">/** <span class="attrib">@ignore</span> */</span>
jala.Test.TestException.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
   <span class="reserved">return</span> <span class="literal">"jala.Test.TestException in "</span> + <span class="reserved">this</span>.functionName +
          <span class="literal">": "</span> + <span class="reserved">this</span>.message;
};

<span class="comment">/**
 * Creates a new ArgumentsException instance
 * <span class="attrib">@class</span> Instances of this exception are thrown whenever an assertion
 * function is called with incorrect or insufficient arguments
 * <span class="attrib">@param</span> {String} message The failure message
 * <span class="attrib">@returns</span> A newly created ArgumentsException instance
 * <span class="attrib">@constructor</span>
 */</span>
jala.Test.ArgumentsException = <span class="reserved">function</span> ArgumentsException(message) {
   <span class="reserved">this</span>.functionName = null;
   <span class="reserved">this</span>.message = message;
   <span class="reserved">this</span>.stackTrace = jala.Test.getStackTrace(message);
   <span class="reserved">return</span> <span class="reserved">this</span>;
};
jala.Test.ArgumentsException.<span class="reserved">prototype</span> = new jala.Test.Exception();

<span class="comment">/** <span class="attrib">@ignore</span> */</span>
jala.Test.ArgumentsException.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
   <span class="reserved">return</span> <span class="literal">"jala.Test.ArgumentsException in "</span> + <span class="reserved">this</span>.functionName +
          <span class="literal">": "</span> + <span class="reserved">this</span>.message;
};

<span class="comment">/**
 * Creates a new EvaluatorException instance
 * <span class="attrib">@class</span> Instances of this exception are thrown when attempt
 * to evaluate the test code fails
 * <span class="attrib">@param</span> {String} message The failure message
 * <span class="attrib">@returns</span> A newly created EvaluatorException instance
 * <span class="attrib">@constructor</span>
 */</span>
jala.Test.EvaluatorException = <span class="reserved">function</span> EvaluatorException(message) {
   <span class="reserved">this</span>.message = message;
   <span class="reserved">return</span> <span class="reserved">this</span>;
};
jala.Test.EvaluatorException.<span class="reserved">prototype</span> = new jala.Test.Exception();

<span class="comment">/** <span class="attrib">@ignore</span> */</span>
jala.Test.EvaluatorException.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
   <span class="reserved">return</span> <span class="literal">"jala.Test.EvaluatorException: "</span> + <span class="reserved">this</span>.message;
};



<span class="comment">/*************************************************
 ***** R E S U L T   C O N S T R U C T O R S *****
 *************************************************/</span>


<span class="comment">/**
 * Constructs a new TestResult instance
 * <span class="attrib">@class</span> Instances of this class represent the result of the execution
 * of a single test file
 * <span class="attrib">@param</span> {String} testFileName The name of the excecuted test file
 * <span class="attrib">@returns</span> A new TestResult instance
 * <span class="attrib">@constructor</span>
 */</span>
jala.Test.TestResult = <span class="reserved">function</span>(testFileName) {
   <span class="reserved">this</span>.name = testFileName;
   <span class="reserved">this</span>.elapsed = 0;
   <span class="reserved">this</span>.status = jala.Test.PASSED;
   <span class="reserved">this</span>.log = [];
   <span class="reserved">return</span> <span class="reserved">this</span>;
};

<span class="comment">/**
 * Constructs a new TestFunctionResult instance
 * <span class="attrib">@class</span> Instances of this class represent the result of the successful
 * execution of a single test function (failed executions will be represented
 * as Exceptions in the log of a test result).
 * <span class="attrib">@param</span> {String} functionName The name of the excecuted test function
 * <span class="attrib">@param</span> {Date} startTime A Date instance marking the begin of the test
 * <span class="attrib">@returns</span> A new TestFunctionResult instance
 * <span class="attrib">@constructor</span>
 */</span>
jala.Test.TestFunctionResult = <span class="reserved">function</span>(functionName, startTime) {
   <span class="reserved">this</span>.functionName = functionName;
   <span class="reserved">this</span>.elapsed = (new Date()) - startTime;
   <span class="reserved">return</span> <span class="reserved">this</span>;
};



<span class="comment">/*************************************************
 ***** P R O T O T Y P E   F U N C T I O N S *****
 *************************************************/</span>


<span class="comment">/**
 * Executes a single test file
 * <span class="attrib">@param</span> {helma.File} testFile The file containing the test to run
 */</span>
jala.Test.<span class="reserved">prototype</span>.executeTest = <span class="reserved">function</span>(testFile) {
   var testFileName = testFile.getName();
   <span class="comment">// store the name of the current test in res.meta.currentTest</span>
   <span class="comment">// as this is needed in getStackTrace</span>
   res.meta.currentTest = testFileName;

   var cx = Packages.org.mozilla.javascript.Context.enter();
   var code = new java.lang.String(testFile.readAll() || <span class="literal">""</span>);
   var testResult = new jala.Test.TestResult(testFileName);
   try {
      <span class="comment">// instantiate a new test scope</span>
      var scope = jala.Test.getTestScope(scope);
      <span class="comment">// evaluate the test file in the per-thread which is garbage</span>
      <span class="comment">// collected at the end of the test run and prevents the application</span>
      <span class="comment">// scope from being polluted</span>
      cx.evaluateString(scope, code, testFileName, 1, null);
      <span class="reserved">if</span> (!scope.tests || scope.tests.constructor != Array || scope.tests.length == 0) {
         throw <span class="literal">"Please define an Array named 'tests' containing the names of the test functions to run"</span>;
      }
      var start = new Date();
      <span class="comment">// run the test</span>
      try {
         <span class="reserved">if</span> (scope.setup != null &amp;&amp; scope.setup instanceof Function) {
            <span class="comment">// setup function exists, so call it</span>
            testResult.log[testResult.log.length] = <span class="reserved">this</span>.executeTestFunction(<span class="literal">"setup"</span>, scope);
         }
         <span class="comment">// run all test methods defined in the array "tests"</span>
         var functionName;
         <span class="reserved">for</span> (var i=0;i&lt;scope.tests.length;i++) {
            functionName = scope.tests[i];
            <span class="reserved">if</span> (!scope[functionName] || scope[functionName].constructor != Function) {
               throw new jala.Test.EvaluatorException(<span class="literal">"Test function '"</span> +
                                         functionName + <span class="literal">"' is not defined."</span>);
            }
            testResult.log[testResult.log.length] = <span class="reserved">this</span>.executeTestFunction(functionName, scope);
         }
      } catch (e) {
         <span class="reserved">this</span>.testsFailed += 1;
         testResult.status = jala.Test.FAILED;
         testResult.log[testResult.log.length] = e;
      } finally {
         <span class="comment">// call any existing "cleanup" method</span>
         <span class="reserved">if</span> (scope.cleanup != null &amp;&amp; scope.cleanup instanceof Function) {
            testResult.log[testResult.log.length] = <span class="reserved">this</span>.executeTestFunction(<span class="literal">"cleanup"</span>, scope);
         }
      }
   } catch (e) {
      <span class="reserved">this</span>.testsFailed += 1;
      testResult.status = jala.Test.FAILED;
      testResult.log[testResult.log.length] = new jala.Test.EvaluatorException(e.toString());
   } finally {
      <span class="comment">// exit the js context created above</span>
      cx.exit();
      <span class="comment">// clear res.meta.currentTest</span>
      res.meta.currentTest = null;
   }
   testResult.elapsed = (new Date()) - start;
   <span class="reserved">this</span>.results[<span class="reserved">this</span>.results.length] = testResult;
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Executes a single test function
 * <span class="attrib">@param</span> {String} functionName The name of the test function to execute
 * <span class="attrib">@param</span> {helma.scripting.rhino.GlobalObject} scope The scope to execute
 * the test method in
 */</span>
jala.Test.<span class="reserved">prototype</span>.executeTestFunction = <span class="reserved">function</span>(functionName, scope) {
   <span class="comment">// store the name of the current function in res.meta.currentTestFunction</span>
   res.meta.currentTestFunction = functionName;
   var start = new Date();
   try {
      scope[functionName]();
      <span class="reserved">this</span>.functionsPassed += 1;
      <span class="reserved">return</span> new jala.Test.TestFunctionResult(functionName, start);
   } catch (e) {
      <span class="reserved">if</span> (e instanceof jala.Test.Exception) {
         e.functionName = functionName;
      } <span class="reserved">else</span> {
         e = new jala.Test.EvaluatorException(e.toString());
      }
      <span class="reserved">this</span>.functionsFailed += 1;
      throw e;
   } finally {
      <span class="comment">// clear res.meta.currentFunction</span>
      res.meta.currentTestFunction = null;
   }
};

<span class="comment">/**
 * Main test execution function
 * <span class="attrib">@param</span> {String|Array} what Either the name of a single test file
 * or an array containing the names of several function files that should
 * be executed.
 */</span>
jala.Test.<span class="reserved">prototype</span>.execute = <span class="reserved">function</span>(what) {
   var self = <span class="reserved">this</span>;
   var executeTest = <span class="reserved">function</span>(fileName) {
      var file = jala.Test.getTestFile(fileName);
      <span class="reserved">if</span> (file != null &amp;&amp; file.exists()) {
         self.testsRun += 1;
         self.executeTest(file);
      }
   };

   <span class="reserved">if</span> (what instanceof Array) {
      <span class="reserved">for</span> (var i in what) {
         executeTest(what[i]);
      }
   } <span class="reserved">else</span> {
      executeTest(what);
   }
   <span class="reserved">return</span>;
};

<span class="comment">/** <span class="attrib">@ignore</span> */</span>
jala.Test.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
   <span class="reserved">return</span> <span class="literal">"[jala.Test]"</span>;
};

<span class="comment">/**
 * Renders the results of all tests done by this test instance
 * to response.
 */</span>
jala.Test.<span class="reserved">prototype</span>.renderResults = <span class="reserved">function</span>() {
   <span class="reserved">if</span> (<span class="reserved">this</span>.results.length &gt; 0) {
      <span class="reserved">for</span> (var i=0;i&lt;<span class="reserved">this</span>.results.length;i++) {
         <span class="reserved">this</span>.renderResult(<span class="reserved">this</span>.results[i]);
      }
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Renders a single the result of a single test
 * <span class="attrib">@param</span> {jala.Test.TestResult} The result to render
 */</span>
jala.Test.<span class="reserved">prototype</span>.renderResult = <span class="reserved">function</span>(result) {
   res.push();
   var logItem;
   <span class="reserved">for</span> (var i=0;i&lt;result.log.length;i++) {
      logItem = result.log[i];
      <span class="reserved">if</span> (logItem instanceof jala.Test.Exception) {
         renderSkin(<span class="literal">"jala.Test.log.failed"</span>, logItem);
      } <span class="reserved">else</span> {
         renderSkin(<span class="literal">"jala.Test.log.passed"</span>, logItem);
      }
   }
   var param = {
      name: result.name,
      elapsed: result.elapsed,
      status: result.status,
      log: res.pop()
   }
   renderSkin(<span class="literal">"jala.Test.result"</span>, param);
   <span class="reserved">return</span>;
};



<span class="comment">/***********************
 ***** M A C R O S *****
 ***********************/</span>


<span class="comment">/**
 * Renders the list of available tests
 */</span>
jala.Test.<span class="reserved">prototype</span>.list_macro = <span class="reserved">function</span>() {
   var list = jala.Test.getTestFiles();
   <span class="reserved">if</span> (list &amp;&amp; list.length &gt; 0) {
      var fileName, skinParam;
      <span class="reserved">for</span> (var i=0;i&lt;list.length;i++) {
         fileName = list[i];
         skinParam = {name: fileName};
         <span class="reserved">if</span> (req.data.test == fileName ||
                   (req.data.test_array &amp;&amp; req.data.test_array.contains(fileName))) {
            skinParam.checked = <span class="literal">"checked"</span>;
         }
         renderSkin(<span class="literal">"jala.Test.item"</span>, skinParam);
      }
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Renders the test results
 */</span>
jala.Test.<span class="reserved">prototype</span>.results_macro = <span class="reserved">function</span>() {
   <span class="reserved">this</span>.renderResults();
   <span class="reserved">return</span>;
};



<span class="comment">/*************************************************
 ***** A S S E R T I O N   F U N C T I O N S *****
 *************************************************/</span>


<span class="comment">/**
 * Checks if the value passed as argument is boolean true.
 * <span class="attrib">@param</span> {Object} val The value that should be boolean true.
 * <span class="attrib">@throws</span> jala.Test.ArgumentsException
 * <span class="attrib">@throws</span> jala.Test.TestException
 */</span>
jala.Test.<span class="reserved">prototype</span>.assertTrue = <span class="reserved">function</span> assertTrue(val) {
   var functionName = arguments.callee.name;
   var argsExpected = arguments.callee.length;
   jala.Test.evalArguments(arguments, argsExpected);
   var comment = jala.Test.getComment(arguments, argsExpected);
   var value = jala.Test.getValue(arguments, argsExpected, 0);
   <span class="reserved">if</span> (typeof(value) != <span class="literal">"boolean"</span>) {
      throw new jala.Test.ArgumentsException(<span class="literal">"Invalid argument to assertTrue(boolean): "</span> +
                      jala.Test.valueToString(value));
   } <span class="reserved">else</span> <span class="reserved">if</span> (value !== true) {
      throw new jala.Test.TestException(comment,
                      <span class="literal">"assertTrue(boolean) called with argument "</span> +
                      jala.Test.valueToString(value));
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Checks if the value passed as argument is boolean false.
 * <span class="attrib">@param</span> {Object} val The value that should be boolean false.
 * <span class="attrib">@throws</span> jala.Test.ArgumentsException
 * <span class="attrib">@throws</span> jala.Test.TestException
 */</span>
jala.Test.<span class="reserved">prototype</span>.assertFalse = <span class="reserved">function</span> assertFalse(val) {
   var functionName = arguments.callee.name;
   var argsExpected = arguments.callee.length;
   jala.Test.evalArguments(arguments, argsExpected);
   var comment = jala.Test.getComment(arguments, argsExpected);
   var value = jala.Test.getValue(arguments, argsExpected, 0);
   <span class="reserved">if</span> (typeof(value) != <span class="literal">"boolean"</span>) {
      throw new jala.Test.ArgumentsException(<span class="literal">"Invalid argument to assertFalse(boolean): "</span> +
                      jala.Test.valueToString(value));
   } <span class="reserved">else</span> <span class="reserved">if</span> (value === true) {
      throw new jala.Test.TestException(comment,
                      <span class="literal">"assertFalse(boolean) called with argument "</span> +
                      jala.Test.valueToString(value));
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Checks if the values passed as arguments are equal.
 * <span class="attrib">@param</span> {Object} val1 The value that should be compared to the second argument.
 * <span class="attrib">@param</span> {Object} val2 The value that should be compared to the first argument.
 * <span class="attrib">@throws</span> jala.Test.ArgumentsException
 * <span class="attrib">@throws</span> jala.Test.TestException
 */</span>
jala.Test.<span class="reserved">prototype</span>.assertEqual = <span class="reserved">function</span> assertEqual(val1, val2) {
   var functionName = arguments.callee.name;
   var argsExpected = arguments.callee.length;
   jala.Test.evalArguments(arguments, argsExpected);
   var comment = jala.Test.getComment(arguments, argsExpected);
   var value1 = jala.Test.getValue(arguments, argsExpected, 0);
   var value2 = jala.Test.getValue(arguments, argsExpected, 1);
   <span class="reserved">if</span> (value1 !== value2) {
      throw new jala.Test.TestException(comment,
                      <span class="literal">"Expected "</span> + jala.Test.valueToString(value1) +
                      <span class="literal">" to be equal to "</span> + jala.Test.valueToString(value2));
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Checks if the values passed as arguments are not equal.
 * <span class="attrib">@param</span> {Object} val1 The value that should be compared to the second argument.
 * <span class="attrib">@param</span> {Object} val2 The value that should be compared to the first argument.
 * <span class="attrib">@throws</span> jala.Test.ArgumentsException
 * <span class="attrib">@throws</span> jala.Test.TestException
 */</span>
jala.Test.<span class="reserved">prototype</span>.assertNotEqual = <span class="reserved">function</span> assertNotEqual(val1, val2) {
   var functionName = arguments.callee.name;
   var argsExpected = arguments.callee.length;
   jala.Test.evalArguments(arguments, argsExpected);
   var value1 = jala.Test.getValue(arguments, argsExpected, 0);
   var value2 = jala.Test.getValue(arguments, argsExpected, 1);
   var comment = jala.Test.getComment(arguments, argsExpected);
   <span class="reserved">if</span> (value1 === value2) {
      throw new jala.Test.TestException(comment,
                      <span class="literal">"Expected "</span> + jala.Test.valueToString(value1) +
                      <span class="literal">" to be not equal to "</span> + jala.Test.valueToString(value2));
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Checks if the value passed as argument is null.
 * <span class="attrib">@param</span> {Object} val The value that should be null.
 * <span class="attrib">@throws</span> jala.Test.ArgumentsException
 * <span class="attrib">@throws</span> jala.Test.TestException
 */</span>
jala.Test.<span class="reserved">prototype</span>.assertNull = <span class="reserved">function</span> assertNull(val) {
   var functionName = arguments.callee.name;
   var argsExpected = arguments.callee.length;
   jala.Test.evalArguments(arguments, argsExpected);
   var comment = jala.Test.getComment(arguments, argsExpected);
   var value = jala.Test.getValue(arguments, argsExpected, 0);
   <span class="reserved">if</span> (value !== null) {
      throw new jala.Test.TestException(comment,
                           <span class="literal">"Expected "</span> + jala.Test.valueToString(value) +
                           <span class="literal">" to be null"</span>);
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Checks if the value passed as argument is not null.
 * <span class="attrib">@param</span> {Object} val The value that should be not null.
 * <span class="attrib">@throws</span> jala.Test.ArgumentsException
 * <span class="attrib">@throws</span> jala.Test.TestException
 */</span>
jala.Test.<span class="reserved">prototype</span>.assertNotNull = <span class="reserved">function</span> assertNotNull(val) {
   var functionName = arguments.callee.name;
   var argsExpected = arguments.callee.length;
   jala.Test.evalArguments(arguments, argsExpected);
   var comment = jala.Test.getComment(arguments, argsExpected);
   var value = jala.Test.getValue(arguments, argsExpected, 0);
   <span class="reserved">if</span> (value === null) {
      throw new jala.Test.TestException(comment,
                           <span class="literal">"Expected "</span> + jala.Test.valueToString(value) +
                           <span class="literal">" to be not null"</span>);
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Checks if the value passed as argument is undefined.
 * <span class="attrib">@param</span> {Object} val The value that should be undefined.
 * <span class="attrib">@throws</span> jala.Test.ArgumentsException
 * <span class="attrib">@throws</span> jala.Test.TestException
 */</span>
jala.Test.<span class="reserved">prototype</span>.assertUndefined = <span class="reserved">function</span> assertUndefined(val) {
   var functionName = arguments.callee.name;
   var argsExpected = arguments.callee.length;
   jala.Test.evalArguments(arguments, argsExpected);
   var comment = jala.Test.getComment(arguments, argsExpected);
   var value = jala.Test.getValue(arguments, argsExpected, 0);
   <span class="reserved">if</span> (value !== undefined) {
      throw new jala.Test.TestException(comment,
                           <span class="literal">"Expected "</span> + jala.Test.valueToString(value) +
                           <span class="literal">" to be undefined"</span>);
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Checks if the value passed as argument is not undefined.
 * <span class="attrib">@param</span> {Object} val The value that should be not undefined.
 * <span class="attrib">@throws</span> jala.Test.ArgumentsException
 * <span class="attrib">@throws</span> jala.Test.TestException
 */</span>
jala.Test.<span class="reserved">prototype</span>.assertNotUndefined = <span class="reserved">function</span> assertNotUndefined(val) {
   var functionName = arguments.callee.name;
   var argsExpected = arguments.callee.length;
   jala.Test.evalArguments(arguments, argsExpected);
   var comment = jala.Test.getComment(arguments, argsExpected);
   var value = jala.Test.getValue(arguments, argsExpected, 0);
   <span class="reserved">if</span> (value === undefined) {
      throw new jala.Test.TestException(comment,
                           <span class="literal">"Expected argument to be not undefined"</span>);
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Checks if the value passed as argument is NaN.
 * <span class="attrib">@param</span> {Object} val The value that should be NaN.
 * <span class="attrib">@throws</span> jala.Test.ArgumentsException
 * <span class="attrib">@throws</span> jala.Test.TestException
 */</span>
jala.Test.<span class="reserved">prototype</span>.assertNaN = <span class="reserved">function</span> assertNaN(val) {
   var functionName = arguments.callee.name;
   var argsExpected = arguments.callee.length;
   jala.Test.evalArguments(arguments, argsExpected);
   var comment = jala.Test.getComment(arguments, argsExpected);
   var value = jala.Test.getValue(arguments, argsExpected, 0);
   <span class="reserved">if</span> (!isNaN(value)) {
      throw new jala.Test.TestException(comment,
                           <span class="literal">"Expected "</span> + jala.Test.valueToString(value) +
                           <span class="literal">" to be NaN"</span>);
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Checks if the value passed as argument is not NaN.
 * <span class="attrib">@param</span> {Object} val The value that should be not NaN.
 * <span class="attrib">@throws</span> jala.Test.ArgumentsException
 * <span class="attrib">@throws</span> jala.Test.TestException
 */</span>
jala.Test.<span class="reserved">prototype</span>.assertNotNaN = <span class="reserved">function</span> assertNotNaN(val) {
   var functionName = arguments.callee.name;
   var argsExpected = arguments.callee.length;
   jala.Test.evalArguments(arguments, argsExpected);
   var comment = jala.Test.getComment(arguments, argsExpected);
   var value = jala.Test.getValue(arguments, argsExpected, 0);
   <span class="reserved">if</span> (isNaN(value)) {
      throw new jala.Test.TestException(comment,
                           <span class="literal">"Expected "</span> + jala.Test.valueToString(value) +
                           <span class="literal">" to be a number"</span>);
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Checks if the value passed as argument contains the pattern specified.
 * <span class="attrib">@param</span> {String} val The string that should contain the pattern
 * <span class="attrib">@param</span> {String} str The string that should be contained
 * <span class="attrib">@throws</span> jala.Test.ArgumentsException
 * <span class="attrib">@throws</span> jala.Test.TestException
 */</span>
jala.Test.<span class="reserved">prototype</span>.assertStringContains = <span class="reserved">function</span> assertStringContains(val, str) {
   var functionName = arguments.callee.name;
   var argsExpected = arguments.callee.length;
   jala.Test.evalArguments(arguments, argsExpected);
   var comment = jala.Test.getComment(arguments, argsExpected);
   var value = jala.Test.getValue(arguments, argsExpected, 0);
   var pattern = jala.Test.getValue(arguments, argsExpected, 1);
   <span class="reserved">if</span> (pattern.constructor == String) {
      <span class="reserved">if</span> (value.indexOf(pattern) &lt; 0) {
         throw new jala.Test.TestException(comment,
                              <span class="literal">"Expected string "</span> + jala.Test.valueToString(pattern) +
                              <span class="literal">" to be found in "</span> + jala.Test.valueToString(value));
      }
   } <span class="reserved">else</span> {
      throw new jala.Test.ArgumentsException(<span class="literal">"Invalid argument to assertStringContains(string, string): "</span> +
                      jala.Test.valueToString(pattern));
   }
   <span class="reserved">return</span>;
};

<span class="comment">/**
 * Checks if the regular expression matches the string.
 * <span class="attrib">@param</span> {String} val The string that should contain the regular expression pattern
 * <span class="attrib">@param</span> {RegExp} rxp The regular expression that should match the value
 * <span class="attrib">@throws</span> jala.Test.ArgumentsException
 * <span class="attrib">@throws</span> jala.Test.TestException
 */</span>
jala.Test.<span class="reserved">prototype</span>.assertMatch = <span class="reserved">function</span> assertStringContains(val, rxp) {
   var functionName = arguments.callee.name;
   var argsExpected = arguments.callee.length;
   jala.Test.evalArguments(arguments, argsExpected);
   var comment = jala.Test.getComment(arguments, argsExpected);
   var value = jala.Test.getValue(arguments, argsExpected, 0);
   var exp = jala.Test.getValue(arguments, argsExpected, 1);
   <span class="reserved">if</span> (exp.constructor == RegExp) {
      <span class="reserved">if</span> (exp.test(value) == false) {
         throw new jala.Test.TestException(comment,
                              <span class="literal">"Expected pattern "</span> + jala.Test.valueToString(exp) +
                              <span class="literal">" to match "</span> + jala.Test.valueToString(value));
      }
   } <span class="reserved">else</span> {
      throw new jala.Test.ArgumentsException(<span class="literal">"Invalid argument to assertMatch(string, regexp): "</span> +
                      jala.Test.valueToString(pattern));
   }
   <span class="reserved">return</span>;
};



<span class="comment">/*********************************
 ***** H T T P   C L I E N T *****
 *********************************/</span>


<span class="comment">/**
 * Constructs a new HttpClient instance
 * <span class="attrib">@class</span> Instances of this class represent a http client useable for
 * testing, as any session cookies received by the tested application
 * are stored and used for subsequent requests, allowing simple "walkthrough"
 * tests.
 * <span class="attrib">@returns</span> A newly constructed HttpClient
 * <span class="attrib">@constructor</span>
 */</span>
jala.Test.HttpClient = <span class="reserved">function</span>() {
   var client = new helma.Http();
   var cookie = null;

   <span class="comment">/**
    * Returns the http client used
    * <span class="attrib">@return</span> The http client used
    * <span class="attrib">@type</span> helma.Http
    */</span>
   <span class="reserved">this</span>.getClient = <span class="reserved">function</span>() {
      <span class="reserved">return</span> client;
   };
   
   <span class="comment">/**
    * Sets the cookie to use for subsequent requests using this client
    * <span class="attrib">@param</span> {Object} c The cookie object as received from helma.Http.getUrl
    */</span>
   <span class="reserved">this</span>.setCookie = <span class="reserved">function</span>(c) {
      cookie = c;
      <span class="reserved">return</span>;
   };

   <span class="comment">/**
    * Returns the cookie set for this http client
    */</span>
   <span class="reserved">this</span>.getCookie = <span class="reserved">function</span>() {
      <span class="reserved">return</span> cookie;
   };

   <span class="reserved">return</span> <span class="reserved">this</span>;
};

<span class="comment">/**
 * Sends a HTTP request to the Url passed as argument
 * <span class="attrib">@param</span> {String} method The HTTP method to use
 * <span class="attrib">@param</span> {String} url The url to request
 * <span class="attrib">@param</span> {Object} param A parameter object to use with this request
 * <span class="attrib">@return</span> An object containing response values
 * <span class="attrib">@see</span> helma.Http.prototype.getUrl
 */</span>
jala.Test.HttpClient.<span class="reserved">prototype</span>.executeRequest = <span class="reserved">function</span>(method, url, param) {
   var client = <span class="reserved">this</span>.getClient();
   client.setMethod(method);
   var cookie = <span class="reserved">this</span>.getCookie();
   <span class="reserved">if</span> (cookie != null) {
       client.setCookie(cookie.name, cookie.value);
   }
   <span class="comment">// prevent any caching at the remote server or any intermediate proxy</span>
   client.setHeader(<span class="literal">"Cache-control"</span>, <span class="literal">"no-cache,max-age=0"</span>);
   client.setContent(param);
   <span class="comment">// disable following redirects, since cookies would get lost</span>
   <span class="comment">// instead, handle a resulting redirect manually</span>
   client.setFollowRedirects(false);
   var result = client.getUrl(url);
   <span class="reserved">if</span> (result.cookie != null) {
      <span class="reserved">this</span>.setCookie(result.cookie);
   }
   <span class="reserved">if</span> (result.location != null) {
      <span class="comment">// received a redirect location, so follow it</span>
      result = <span class="reserved">this</span>.executeRequest(<span class="literal">"GET"</span>, result.location);
   }
   <span class="reserved">return</span> result;
};

<span class="comment">/**
 * Convenience method for requesting the url passed as argument
 * using method GET
 * <span class="attrib">@param</span> {String} url The url to request
 * <span class="attrib">@param</span> {Object} param A parameter object to use with this request
 * <span class="attrib">@return</span> An object containing response values
 * <span class="attrib">@see</span> helma.Http.prototype.getUrl
 */</span>
jala.Test.HttpClient.<span class="reserved">prototype</span>.getUrl = <span class="reserved">function</span>(url, param) {
   <span class="reserved">return</span> <span class="reserved">this</span>.executeRequest(<span class="literal">"GET"</span>, url, param);
};

<span class="comment">/**
 * Convenience method for submitting a form.
 * <span class="attrib">@param</span> {String} url The url to request
 * <span class="attrib">@param</span> {Object} param A parameter object to use with this request
 * <span class="attrib">@return</span> An object containing response values
 * <span class="attrib">@see</span> helma.Http.prototype.getUrl
 */</span>
jala.Test.HttpClient.<span class="reserved">prototype</span>.submitForm = <span class="reserved">function</span>(url, param) {
   <span class="reserved">return</span> <span class="reserved">this</span>.executeRequest(<span class="literal">"POST"</span>, url, param);
};

<span class="comment">/** <span class="attrib">@ignore</span> */</span>
jala.Test.HttpClient.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
   <span class="reserved">return</span> <span class="literal">"[jala.Test.HttpClient]"</span>;
};




<span class="comment">/*****************************************************
 ***** T E S T   D A T A B A S E   M A N A G E R *****
 *****************************************************/</span>


<span class="comment">/**
 * Returns a newly created DatabaseMgr instance
 * <span class="attrib">@class</span> Instances of this class allow managing test databases
 * and switching a running application to an in-memory test
 * database to use within a unit test.
 * <span class="attrib">@returns</span> A newly created instance of DatabaseMgr
 * <span class="attrib">@constructor</span>
 */</span>
jala.Test.DatabaseMgr = <span class="reserved">function</span>() {
   <span class="comment">/**
    * Map containing all test databases
    */</span>
   <span class="reserved">this</span>.databases = {};

   <span class="comment">/**
    * Map containing the original datasource
    * properties that were temporarily deactivated
    * by activating a test database
    */</span>
   <span class="reserved">this</span>.dbSourceProperties = {};

   <span class="reserved">return</span> <span class="reserved">this</span>;
};

<span class="comment">/**
 * Switches the application datasource with the given name
 * to a newly created in-memory database. In addition this method
 * also clears the application cache and invalidates the root
 * object to ensure that everything is re-retrieved from the
 * test database.
 * <span class="attrib">@param</span> {String} dbSourceName The name of the application database
 * source as defined in db.properties
 * <span class="attrib">@param</span> {Boolean} copyTables If true this method also copies all
 * tables in the source database to the test database (excluding
 * indexes). 
 * <span class="attrib">@returns</span> The test database
 * <span class="attrib">@type</span> jala.db.RamDatabase
 */</span>
jala.Test.DatabaseMgr.<span class="reserved">prototype</span>.startDatabase = <span class="reserved">function</span>(dbSourceName, copyTables) {
   try {
      var testDb = new jala.db.RamDatabase(dbSourceName);
      <span class="comment">// switch the datasource to the test database</span>
      var dbSource = app.getDbSource(dbSourceName);
      <span class="reserved">if</span> (copyTables === true) {
         testDb.copyTables(dbSource);
      }
      var oldProps = dbSource.switchProperties(testDb.getProperties());
      <span class="comment">// store the test database in this manager for use in stopAll()</span>
      <span class="reserved">this</span>.databases[dbSourceName] = testDb;
      <span class="reserved">this</span>.dbSourceProperties[dbSourceName] = oldProps;
      <span class="comment">// clear the application cache and invalidate root</span>
      app.clearCache();
      root.invalidate();
      <span class="reserved">return</span> testDb;
   } catch (e) {
      throw new jala.Test.EvaluatorException(<span class="literal">"Unable to switch to test database, reason: "</span> + e);
   }
};

<span class="comment">/**
 * Stops all registered test databases and and reverts the application
 * to its original datasource(s) as defined in db.properties file.
 * In addition this method commits all pending changes within the request,
 * cleares the application cache and invalidates the root object
 * to ensure no traces of the test database are left behind.
 */</span>
jala.Test.DatabaseMgr.<span class="reserved">prototype</span>.stopAll = <span class="reserved">function</span>() {
   <span class="comment">// commit all pending changes</span>
   res.commit();
   try {
      <span class="comment">// loop over all registered databases and revert the appropriate</span>
      <span class="comment">// datasource back to the original database</span>
      var testDb, dbSource;
      <span class="reserved">for</span> (var dbSourceName in <span class="reserved">this</span>.databases) {
         testDb = <span class="reserved">this</span>.databases[dbSourceName];
         dbSource = app.getDbSource(dbSourceName);
         dbSource.switchProperties(<span class="reserved">this</span>.dbSourceProperties[dbSourceName]);
         testDb.shutdown();
      }
      <span class="comment">// clear the application cache and invalidate root</span>
      app.clearCache();
      root.invalidate();
   } catch (e) {
      throw new jala.Test.EvaluatorException(<span class="literal">"Unable to stop test databases, reason: "</span> + e);
   }
   <span class="reserved">return</span>;
};
</pre>
	<hr>



<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> <font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top"><em>
<b>Jala Test</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<font size="-1">

</font>
<div class="jsdoc_ctime">Documentation generated by <a href="http://jsdoc.sourceforge.net/" target="_parent">JSDoc</a> on Thu Mar 15 14:24:11 2007</div>
</body>
</html>
